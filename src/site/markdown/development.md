<!--
Copyright 2016 Development Entropy (deventropy.org) Contributors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

# Development Entropy Common Development Guidelines

This is a work in progress page, hopefully that will be built as we progress with the projects. For now, holds some
scraps of information.

Anything noted here with respect to Git repositories applies to project repositories, not `*.github.io` site repositories
or other script/ancillary repositories.

## Git Repository Layout

The projects are laid out as a single Git repository with Maven multi-module project layout. All SCM (Git) and Build
(Maven) operations are executed at the parent project directory.

### Branches & (protected) branches

A full branching strategy / plan is in the works, for now these are some ideas. Basic ideas include:

* All development happens on *public* feature or bugfix branches
* Use local branches and squash commits to *public* branches
* Release trains run on their own branches.

#### master

This is a *protected* branch; so direct commits to this branch are not possible, neither is it possible to merge anything
to this branch directly without certain checks, currently:

* Clean merge (without conflicts)
* Travis CI build pass on the other branch (or pull request)

**NOTE/TODO:** We still have to clarify how the interaction between `master` and `release` branches will work.

#### gh-pages

This is of course the special GitHub pages **orphan** branch from which we serve this website. All the content of this
branch is generated by maven. If static files like `CNAME` are required; they should be placed in the
`src/site/resources` folder of the regular branch from which the site is generated.

**TODO: On Site Generation**

* Automate site generation / deployment
* Think about what to do if we want to support multi-version sites (major versions).
* Think about how to handle `.*` files (like .gitignore); these do not get copied over by the site plugin.

#### release/* branches

* **Branch Off From:** `master` if on the same *Major* version; or the highest `release/*` branch of the same *Major* version.
* **Merge Back Into:** `master` only if on the same *Major* version.
* **Lifetime:** Stays forever
* **Protected:** Yes (basic). May not need to require Status Checks.

This is a branch from which release are created. The branch is created when we are about ready to create a new *Minor*
release. Only a very few changes (like version update, site update, blocker fixes) are expected on this branch between
the time the branch is created and the first release in that *Major/Minor* series is created. The release is of course
tagged (and the tag should be cryptographically signed, see `-s` or `-u <key>` flags).

After the release is completed, the content should be merged back into `master`, unless master has moved on to the next 
*Major*. If master has moved on, selective / appropriate fixes need to be cherry picked into a feature / bug fix branch
and merged into `master` and any other appropriate `release/*` branch.  

If a *Patch* release is required on that *Major/Minor*, changes can be made on the branch or on a `feature/*` or
`bugfix/*` branch; release created and tagged. After the release the changes are to be merged back to `master` (using
the same rules as above) and any other `release/*` branch in the higher *Minor* branches in the same or higher *Major*
versions.

##### release/*-alpha.x and release/*-beta.x branches

For releases with major or multiple features we may want intermediate `alpha` or public testing `beta` release. To
create these releases, `release/*-alpha.x` and `release/*-beta.x` branches may be created.

These branches are very similar to the `release/*` branches, except:

* The releases created from the branch are not feature complete, hence multiple merges happen to the branch from `master`
	(`feature/*` &#8594; `master` &#8594; *this branch*; `bugfix/*` &#8594; `release/*` &#8594; `master` &#8594;
	*this branch*; etc.) or `feature/*` branches.
* There are usually no *Patch* releases from these branches as any changes/fixes are simply rolled into the next `alhpa`
	or `beta` release.

#### feature/* and bugfix/* branches

* **Branch Off From:** `master` or `release/*`
* **Merge Back Into:** `master` or `release/*` where branched from; or multiple. *No FF*
* **Lifetime:** Time to develop the feature, may involve one or more merges back into the source.
* **Protected:** Temporary (no status checks) to avoid data loss.

This is a branch to develop a single (or multiple related) feature(s) or bug fix(es); and once everything is done the
contents are merged back into where we started from or into multiple branches. Once all done, feel free to delete the
branch.

**Note:** Since this branch is expected to be deleted at some point, make sure the merge from this branch to `master` or
one or more `release/*` branches is done without a Fast Forward (`git merge --no-ff`).

### Git Settings

The following minimal settings are required, in global, system or local configs:

* user.name
* user.email

The following are recommended (change values per your preference):

* core.editor=vi
* core.repositoryformatversion=0
* core.filemode=true
* core.logallrefupdates=true

The following is required / will be added if using the Travis CI client

* travis.slug=deventropy/junit-helper

#### Storing credentials in GNOME Keyring

Git comes with support to store credentials securely in `gnome keyring`, but that code is not compiled. On Ubuntu at
least, do the following:

```
sudo apt-get install libgnome-keyring-dev
cd /usr/share/doc/git/contrib/credential/gnome-keyring
sudo make
git config --global credential.helper /usr/share/doc/git/contrib/credential/gnome-keyring/git-credential-gnome-keyring
```

_Credit: [James Ward on Stackoverflow](https://byteplumbing.net/2014/12/secure-storage-for-http-basic-auth-credentials-with-git/)_

### Git Hooks (local)

Utility Git Hooks

#### pre-push

**Prevent pushing local development branches to GitHub**

If you work with local development branches and have a template for naming those branches (I use the *00_wip/* prefix);
the following [Git Hook](https://git-scm.com/docs/githooks) can be used to prevent pushing the development branches to
the remote (like GitHub).

Steps:

1. Copy the contents of the [script](https://gist.github.com/bindul/f8b4417a57c1fbfa2346#file-pre-push-hook) to a file `$GIT_DIR/hooks/pre-push`
1. Change the script to be executable (`chmod +x`)

<script src="https://gist.github.com/bindul/f8b4417a57c1fbfa2346.js"></script>

### Git Shorthands

* Backup Repository: `git bundle create <backup_folder>/junit-helper-<timestamp>.git --all`
* Show older commits: `git log --pretty=format:"%h %cn"` or `git log --pretty=fuller`
* Squash last n commits: `git rebase -i HEAD~2`
* Merging a branch (non-fast forward): `git checkout <destin>` && `git merge --no-ff <branch-to-merge>`
* Remove a public branch: `git branch -d <branch-to-delete>` && `git push origin --delete <branchName>` OR `git push origin :<branchName>`
* Merging a pull request cheat sheet: <https://gist.github.com/bindul/0f82097018946a4f3028>
* Show Remotes: `git remote -v`
* Change Remote: `git remote set-url <remote-name> <remote-url>`
* Create an orphan branch: `git checkout --orphan <branch_name>`
	* The orphan branch needs some content added and committed / pushed before it is useful

## Version Numbers

The projects aim to adhere to [Semantic Versioning 2.0.0](http://semver.org/) Guidelines; with the following exceptions/
notes:

* Patch Version, as defined by Semver (`Z (x.y.Z | x > 0)`) is omitted if it is 0.
* Pre-release versions (also tracked as [Milestones in the issue management](https://github.com/deventropy/junit-helper/milestones))
	use the `-alpha.n` and `-beta.n` identifiers in the pre-release-candidate stages; and `-rc.n` identifiers for release
	candidates, when required.
	* `-alpha.n` indicate feature incomplete releases
	* `-beta.n` indicate feature complete; public testing versions.

<!--
At this time, a shared version number is used for the entire project; so all the `junit-helper-*` modules share the same
version as the parent. And releases happen at the parent `junit-helper` module to include the child modules. This also
means that after the first public API release (expected to be 1.0), a module may have a release with its version number
incremented without *ANY* changes the module at all, if the release was caused due to changes / fixes in another module(s).
--> 

## Code Guidelines

Some basic coding guidelines (for Java and XML files):

* Follow the checkstyle configuration at <https://raw.githubusercontent.com/deventropy/deventropy-parent/master/deventropy-cq-config/src/main/resources/deventropy/code-quality/checkstyle/deventropy-checkstyle.xml>
** As much as possible, avoid checkstyle warnings
* `Tab`s are **OK**. In fact, I kind of like tabs (keeps files prettier), and I run with `1 TAB == 4 CHARS`
* Line length is <= 120 characters.
* Mostly use 'Eclipse' built in formatter

### Copyright Notice

All source files in the project should have the following copyright and license statement within the appropriate file
types comment section.

```
Copyright <year> Development Entropy (deventropy.org) Contributors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

## Travis Setup

The projects use an almost generic Travis Setup, but we said *almost*. So, the exceptions are:

### Using JFrog OSS Snapshot Repository

We use JFrog OSS Artifactory Instance as our Maven repository, so for builds relying on snapshots of other Deventropy
parents, we are out of luck on default Travis CI settings, as it only checks Central, Sonatype OSS, Apache and
Codehaus (does not exist any more) repositories. The build fails with errors such as:

```
[ERROR] The build could not read 1 project -> [Help 1]
[ERROR]   
[ERROR]   The project org.deventropy.junit-helper:junit-helper:0.1-SNAPSHOT (/home/travis/build/deventropy/junit-helper/pom.xml) has 1 error
[ERROR]     Non-resolvable parent POM: Could not transfer artifact org.deventropy.parent:deventropy-parent:pom:1.0-SNAPSHOT from/to
```

To get around the problem, Google was to our aid and with ideas from a Coderwall blog on
[Deploying maven artifacts from Travis](https://coderwall.com/p/9b_lfq), we proceeded as follows:

1. Set up a branch [travis](https://github.com/deventropy/deventropy-parent/tree/travis) on the parent project.
1. On that branch create a [Maven Settings File](https://github.com/deventropy/deventropy-parent/blob/travis/travis-mvn-settings.xml) with:
	* An active profile, and the profile has all the repositories and plugin repositories we want to check.
1. Define a remote repository with the settings variable as `DENT_TRAVIS_MVN_SETTINGS_REPO` (either in the Travis CI settings UI or as a Global Environment variable in `.travis.yml`).
1. Update `.travis.yml` of the project to have a `before_install` step, which essentially checks out the `travis` branch
	mentioned above into a directory under `target`
	* `before_install: "git clone -b travis ${DENT_TRAVIS_MVN_SETTINGS_REPO} target/travis"`
1. Explicitly set the `install` and `script` entries in `.travis.yml` to use the explicit `settings` file:
	* `"mvn <whatever...> -B --settings target/travis/travis-mvn-settings.xml"`

### Build Matrix

We use a simple build matrix with JDKs:

* Oracle JDK 7 (`oraclejdk7`)
* Oracle JDK 8 (`oraclejdk8`)

There is a mechanism to use JDK 9 EA versions in Travis, but we have not felt the need to use it yet.

### Travis Cache

To speed up build (and savis the nice folks at Travis some network bandwidth), we cache our local Maven repository
(`$HOME/.m2/repository`). However, without the just built artifacts, so there is a `before_cache` stage to remove
files from our group ID: `rm -rf $HOME/.m2/repository/org/deventropy/<group-id>`.

## Coverity Status

The projects use [Coverity](https://scan.coverity.com/) for static code analysis. Coverity
does have support for integrating with Travis CI, but they limit the number of builds that can be submitted for analysis;
so for the moment scans are completed locally and uploaded to the site (could script it later; but not done yet).

To run / upload a coverity scan, download and install the [Coverity Scan Build Tool: Java](https://scan.coverity.com/download?tab=java)
and checkout the branch on which the scan is to be run, then run the following on the command line:

```
$ mvn clean
$ cov-build --dir cov-int mvn -DskipTests=true compile
$ # Make sure you see the following \
	Compilation units (85%) are ready for analysis
	The cov-build utility completed successfully
$ tar czvf <artifactId>.tgz cov-int
```

Upload the `<artifactId>.tgz` script created above to the Coverity project page.
The `<artifactId>.tgz` and `cov-int` file / folder can be removed next.

## Coveralls Setup

The project is set up to upload Jacoco code coverage reports to [coveralls.io](https://coveralls.io/github/deventropy/)
using the `org.eluder.coveralls:coveralls-maven-plugin` [plugin](https://github.com/trautonen/coveralls-maven-plugin).
This plugin uses a repository token to gain access to the project. This token is not part of the POM file and is kept as
an environment variable to be picked up by the plugin using:

```xml
<plugin>
	<groupId>org.eluder.coveralls</groupId>
	<artifactId>coveralls-maven-plugin</artifactId>
	<configuration>
		<repoToken>${env.COVERALLS_REPO_KEY}</repoToken>
	</configuration>
</plugin>
```

The actual property key used (instead of `COVERALLS_REPO_KEY`) can be found in each Top Level Project's `pom.xml`. 

### Running Coveralls from Travis

The `.travis.yml` file has the key encrypted and stored as a global variable:

```
env:
    global:
        # SHARED_UTILS_COVERALLS_REPO_KEY=<secret...>
        - secure: "gbK0c3IbHze8..."
```

The key property is encrypted using the Travis client in the checked out `git` working directory:

```
travis encrypt SHARED_UTILS_COVERALLS_REPO_KEY=<secret...>
```

In the `.travis.yml`, the actual upload requires the `jacoco` report to be generated (as it creates the xml file used by
the plugin to upload the coverage report) and the report is uploaded on successful builds:

```
after_success:
    # Coverage report to coveralls.io (but not for pull requests)
    - '[ "${TRAVIS_PULL_REQUEST}" = "false" ] && mvn clean test jacoco:report coveralls:report'
```

### Running Coveralls locally

The Travis CI environment already has this value as an encrypted global variable (in `.travis.yml`); but if you need to
run the coveralls report (and upload results) locally, do the following:

```
# Set the repository key environment variable (will not work as -DCOVERALLS_REPO_KEY=)
$ export COVERALLS_REPO_KEY=<key_from_coveralls.io>
$ mvn clean test jacoco:report coveralls:report
```

The actual property key used (instead of `COVERALLS_REPO_KEY`) can be found in each Top Level Project's `pom.xml`.

## Codacy Static Code Analysis

Some Deventropy projects use [Codacy's](https://www.codacy.com/app/deventropy) free service for open source projects for
static code analysis. The link above will take you to the team page for all Deventropy projects (the link may not work
unless you are logged into Codacy; each Top Level Project's badge links to the project's Codacy dashboard directly). The
tool uses Git commits on GitHub for static code analysis and no additional steps are required for commits/builds.

<!-- TODO: Add information about configuring Code Patterns on Codacy; sharing configs, etc. --> 

The tool also supports adding test coverage information; that needs to be done from a build, either locally or from our
CI builds at Travis CI. Codacy has has an [API Integration point](https://api.codacy.com/swagger#!/commit/saveCoverage)
to send coverage information to be integrated into the code analysis information. They also provide a tool to upload
coverage information from some standard code coverage tools.

### Codacy client

The [Codacy Coverage Reporter](https://github.com/codacy/codacy-coverage-reporter#setup) uses [JPM](http://jpm4j.org/)
to install and maintain dependencies. The instructions on the Codacy Coverage Reporter GitHub project README page to
install JPM do not work; instead use the instructions on the [JPM site](http://jpm4j.org/#!/md/linux). The instructions
to install the Codacy tool however does work:

```
$ jpm install com.codacy:codacy-coverage-reporter:assembly
```

Since most, if not all, Deventropy projects are setup as Maven multi module projects; the coverage information either
has to be merged into a single one or uploaded individually for each module. For the time being we have not been
able to get Jacoco to generate a single report for a multi-module project; so we are left with uploading reports for
individual modules:

```
$ codacy-coverage-reporter -l Java -r <module path>/target/site/jacoco/jacoco.xml --prefix <module path>/src/main/java/
```

This requires an environment variable `CODACY_PROJECT_TOKEN` set with the project API key from the Codacy project page.

### Running coveralls locally

JPM and Codacy are usually installed locally in a shared / super user mode:

```
$ curl -sL http://bit.ly/jpm4j > jpm4j.jar
$ sudo java -jar jpm4j.jar -g init
$ sudo jpm install com.codacy:codacy-coverage-reporter:assembly
```

__Note the last step might take a minute, and look like it is stuck__

Export the key for the project, run the Jacoco reports and upload the reports for each module:

```
$ export CODACY_PROJECT_TOKEN=<secret...>
$ mvn clean test jacoco:report
# Repeat the following for each module
$ codacy-coverage-reporter -l Java -r <module path>/target/site/jacoco/jacoco.xml --prefix <module path>/src/main/java/
```

<!--TODO Look to script this so as not to need to know the module names; or write a Maven plugin-->

### Uploading coverage from Travis

The Travis build config, `.travis.yml` is configured to generate and upload the coverage information for each build
automatically.

Install `JPM` and `codacy-coverage-reporter`; and update the `PATH` before the build:

```
before_install:
    - 'mkdir --parents target/jpm && curl -sL http://bit.ly/jpm4j > target/jpm/jpm4j.jar && java -jar target/jpm/jpm4j.jar -u init && export PATH=$PATH:$HOME/jpm/bin && jpm install com.codacy:codacy-coverage-reporter:assembly'
```

The `CODACY_PROJECT_TOKEN` is encrupted using the Travis command line client in the project Git checkout working directory:

```
$ travis encrypt CODACY_PROJECT_TOKEN=<secret...>
```

And add it to the `.travis.yml`:

```
env:
    global:
        # CODACY_PROJECT_TOKEN=<secret...>
        - secure: "gbK0c3IbHze8..."
```

And the actual script is run in the `after_success` step. The setup below shares the Jacoco report generation step
between Coveralls and Codacy. If the project does not use Coveralls, skip the `coveralls:report` step:

```
after_success:
    # Coverage report to coveralls.io (but not for pull requests)
    - '[ "${TRAVIS_PULL_REQUEST}" = "false" ] && mvn clean test jacoco:report coveralls:report'
    # The following needs to be repeated for every module (may want to script it at some point)
    - '[ "${TRAVIS_PULL_REQUEST}" = "false" ] && codacy-coverage-reporter -l Java -r <module rel path>/target/site/jacoco/jacoco.xml --prefix <module rel path>/src/main/java/'
```

## Eclipse Setup

Additional Eclipse setup steps:

### Code Template

Set up `Java > Code Style > Code Templates > Comments > Files` to have the following:

```
/* 
 * Copyright ${year} Development Entropy (deventropy.org) Contributors
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
```

### Checkstyle Plug-in

If you have the checkstyle plug-in installed set it up to have an additional `Global Configuration` to point to the
Checkstyle configuration XML file:

* Either, as a `Remote` configuration file pointing to the URL in Code Guidelines above
* Or, if you have the `deventropy-parent` or `deventropy-cq-config` project checked out; as a `Project Relative` configuration.

In both cases, define the `checkstyle.header.file` under `Additional Properties` to point to the `license-header.txt`
file in the same location.

## Build / Maven Setup

### Maven Settings

T.B.D. 
<!-- TODO Complete-->

### Code Signing Settings

T.B.D.
<!-- TODO Complete-->

### GPG Signing Settings

T.B.D.
<!-- TODO Complete-->

### Maven shortcuts

T.B.D.

### Site Generation

* To delete stage folder and stage site: `OD=<site-stage-directory> && rm -rf $OD/* && mvn clean verify site:site site:stage -DstagingDirectory=$OD`
	* The site staging is being replaced with the `mvn-site-stage.sh` script.
* To clean up the checked out `gh-pages` repository: `ls | grep -v '.project' | grep -v '.nojekyll' | grep -v '.git' | grep -v '.gitignore' | xargs rm -r`
* Copy the staged site there; then do a commit and push.

## Issue Management

Though not as good as a JIRA instance, we have GitHub issues to work with. Since we are using the same issue system for
all the modules, here are a few guidelines:

* Try and have properly labeled `component:*` issues to know where an issue belongs.
* For anything that will be fixed, have a proper `milestone` label.
* For any commit to a *public* branch, that is related to an open issue, make sure to refer the issue in the commit
	message.
